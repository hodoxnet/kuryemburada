generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  COMPANY
  COURIER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING
  SUSPENDED
}

enum OrderStatus {
  PENDING
  ASSIGNED
  PICKED_UP
  IN_TRANSIT
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  BANK_TRANSFER
  WALLET
}

enum DocumentType {
  ID_CARD
  LICENSE
  VEHICLE_REGISTRATION
  TAX_PLATE
  INSURANCE
  ADDRESS_PROOF
  CRIMINAL_RECORD
  HEALTH_REPORT
  TAX_DOCUMENT
  TRADE_REGISTRY
  KEP_DOCUMENT
}

enum DocumentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PackageType {
  DOCUMENT
  PACKAGE_SMALL
  PACKAGE_MEDIUM
  PACKAGE_LARGE
  FOOD
  FRAGILE
  OTHER
}

enum UrgencyLevel {
  NORMAL
  URGENT
  VERY_URGENT
}

model User {
  id              Int            @id @default(autoincrement())
  email           String         @unique
  password        String
  role            UserRole
  status          UserStatus     @default(PENDING)
  emailVerified   Boolean        @default(false)
  phoneVerified   Boolean        @default(false)
  lastLogin       DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  company         Company?
  courier         Courier?
  notifications   Notification[]
  refreshTokens   RefreshToken[]
}

model Company {
  id              Int        @id @default(autoincrement())
  userId          Int        @unique
  name            String
  taxNumber       String     @unique
  taxOffice       String
  kepAddress      String?
  phone           String
  address         Json       // {city, district, neighborhood, street, building, floor, etc}
  bankInfo        Json?      // {bankName, branchCode, accountNumber, iban}
  authorizedPerson Json      // {fullName, phone, email, title}
  tradeRegistry   String?
  activityArea    String?
  logo            String?
  status          UserStatus @default(PENDING)
  balance         Decimal    @default(0.00) @db.Decimal(10, 2)
  creditLimit     Decimal    @default(0.00) @db.Decimal(10, 2)
  commission      Decimal    @default(15.00) @db.Decimal(5, 2) // Platform commission percentage
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  user            User       @relation(fields: [userId], references: [id])
  orders          Order[]
  documents       Document[]
  transactions    Transaction[]
  addresses       CompanyAddress[]
}

model CompanyAddress {
  id              Int        @id @default(autoincrement())
  companyId       Int
  title           String
  contactName     String
  contactPhone    String
  address         Json       // {city, district, neighborhood, street, building, floor, etc}
  isDefault       Boolean    @default(false)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  company         Company    @relation(fields: [companyId], references: [id])
  ordersAsPickup  Order[]    @relation("PickupAddress")
  ordersAsDelivery Order[]   @relation("DeliveryAddress")
}

model Courier {
  id              Int        @id @default(autoincrement())
  userId          Int        @unique
  tcNumber        String     @unique
  fullName        String
  birthDate       DateTime
  phone           String
  licenseInfo     Json       // {class, issueDate, expiryDate, number}
  vehicleInfo     Json       // {plate, brand, model, year, type, registrationNumber}
  insuranceInfo   Json       // {company, policyNumber, expiryDate}
  bankInfo        Json       // {bankName, accountNumber, iban}
  emergencyContact Json      // {fullName, phone, relationship}
  address         Json       // {city, district, neighborhood, street}
  status          UserStatus @default(PENDING)
  rating          Decimal    @default(5.00) @db.Decimal(3, 2)
  totalDeliveries Int        @default(0)
  balance         Decimal    @default(0.00) @db.Decimal(10, 2)
  isAvailable     Boolean    @default(true)
  isOnline        Boolean    @default(false)
  lastLocation    Json?      // {lat, lng, timestamp}
  workingHours    Json?      // {monday: {start: "09:00", end: "18:00"}, ...}
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  user            User       @relation(fields: [userId], references: [id])
  orders          Order[]
  documents       Document[]
  earnings        CourierEarning[]
  transactions    Transaction[]
  ratings         CourierRating[]
}

model Order {
  id              Int            @id @default(autoincrement())
  orderNumber     String         @unique
  companyId       Int
  courierId       Int?
  pickupAddressId Int
  deliveryAddressId Int
  recipientName   String
  recipientPhone  String
  packageType     PackageType
  packageSize     String?        // "small", "medium", "large", "extra-large"
  packageWeight   Decimal?       @db.Decimal(6, 2) // in kg
  urgency         UrgencyLevel   @default(NORMAL)
  notes           String?
  specialInstructions String?
  
  distance        Decimal        @db.Decimal(6, 2) // in km
  estimatedTime   Int            // in minutes
  basePrice       Decimal        @db.Decimal(10, 2)
  urgencyFee      Decimal        @default(0.00) @db.Decimal(10, 2)
  distanceFee     Decimal        @default(0.00) @db.Decimal(10, 2)
  totalPrice      Decimal        @db.Decimal(10, 2)
  
  status          OrderStatus    @default(PENDING)
  assignedAt      DateTime?
  pickedUpAt      DateTime?
  deliveredAt     DateTime?
  cancelledAt     DateTime?
  cancellationReason String?
  
  deliveryProof   String?        // Photo URL
  receiverSignature String?      // Signature URL
  trackingCode    String?        @unique
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  company         Company        @relation(fields: [companyId], references: [id])
  courier         Courier?       @relation(fields: [courierId], references: [id])
  pickupAddress   CompanyAddress @relation("PickupAddress", fields: [pickupAddressId], references: [id])
  deliveryAddress CompanyAddress @relation("DeliveryAddress", fields: [deliveryAddressId], references: [id])
  payment         Payment?
  trackingHistory OrderTracking[]
  rating          CourierRating?
}

model OrderTracking {
  id              Int        @id @default(autoincrement())
  orderId         Int
  status          OrderStatus
  location        Json?      // {lat, lng, address}
  note            String?
  createdAt       DateTime   @default(now())
  
  order           Order      @relation(fields: [orderId], references: [id])
}

model Payment {
  id              Int            @id @default(autoincrement())
  orderId         Int            @unique
  amount          Decimal        @db.Decimal(10, 2)
  paymentMethod   PaymentMethod
  status          PaymentStatus  @default(PENDING)
  transactionId   String?
  paidAt          DateTime?
  refundedAt      DateTime?
  refundAmount    Decimal?       @db.Decimal(10, 2)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  order           Order          @relation(fields: [orderId], references: [id])
}

model CourierEarning {
  id              Int        @id @default(autoincrement())
  courierId       Int
  orderId         Int
  baseAmount      Decimal    @db.Decimal(10, 2)
  bonusAmount     Decimal    @default(0.00) @db.Decimal(10, 2)
  totalAmount     Decimal    @db.Decimal(10, 2)
  isPaid          Boolean    @default(false)
  paidAt          DateTime?
  paymentRef      String?
  createdAt       DateTime   @default(now())
  
  courier         Courier    @relation(fields: [courierId], references: [id])
}

model CourierRating {
  id              Int        @id @default(autoincrement())
  orderId         Int        @unique
  courierId       Int
  rating          Int        // 1-5
  comment         String?
  createdAt       DateTime   @default(now())
  
  order           Order      @relation(fields: [orderId], references: [id])
  courier         Courier    @relation(fields: [courierId], references: [id])
}

model Transaction {
  id              Int        @id @default(autoincrement())
  type            String     // "credit", "debit", "commission", "withdrawal", "payment"
  entityType      String     // "company" or "courier"
  entityId        Int
  amount          Decimal    @db.Decimal(10, 2)
  balanceBefore   Decimal    @db.Decimal(10, 2)
  balanceAfter    Decimal    @db.Decimal(10, 2)
  description     String
  referenceId     String?    // Order ID or Payment ID
  status          String     @default("completed")
  createdAt       DateTime   @default(now())
  
  company         Company?   @relation(fields: [entityId], references: [id])
  courier         Courier?   @relation(fields: [entityId], references: [id])
}

model Document {
  id              Int            @id @default(autoincrement())
  entityType      String         // "company" or "courier"
  entityId        Int
  documentType    DocumentType
  fileUrl         String
  fileName        String
  fileSize        Int            // in bytes
  mimeType        String
  status          DocumentStatus @default(PENDING)
  verifiedBy      Int?
  verifiedAt      DateTime?
  rejectionReason String?
  expiryDate      DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  company         Company?       @relation(fields: [entityId], references: [id])
  courier         Courier?       @relation(fields: [entityId], references: [id])
}

model PricingRule {
  id              Int        @id @default(autoincrement())
  ruleType        String     // "distance", "zone", "package_type", "time_slot", "urgency"
  name            String
  description     String?
  parameters      Json       // Flexible JSON for different rule types
  priority        Int        @default(0)
  isActive        Boolean    @default(true)
  validFrom       DateTime?
  validUntil      DateTime?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

model Notification {
  id              Int        @id @default(autoincrement())
  userId          Int
  type            String     // "order", "payment", "system", "promotion"
  title           String
  content         String
  data            Json?      // Additional data for the notification
  isRead          Boolean    @default(false)
  readAt          DateTime?
  createdAt       DateTime   @default(now())
  
  user            User       @relation(fields: [userId], references: [id])
  
  @@index([userId, isRead])
}

model RefreshToken {
  id              Int        @id @default(autoincrement())
  userId          Int
  token           String     @unique
  expiresAt       DateTime
  createdAt       DateTime   @default(now())
  
  user            User       @relation(fields: [userId], references: [id])
  
  @@index([token])
  @@index([userId])
}

model SystemSetting {
  id              Int        @id @default(autoincrement())
  key             String     @unique
  value           Json
  description     String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}